import test from 'tape';
import { mkdtempSync, writeFileSync, rmSync } from 'fs';
import { tmpdir } from 'os';
import { join } from 'path';
import { createESLint } from './helpers/eslint-compat.mjs';
import plugin from 'eslint-plugin-lockfile';

test('non-registry-specifiers rule - package without resolved URL is skipped', async (t) => {
	const tmpDir = mkdtempSync(join(tmpdir(), 'eslint-plugin-lockfile-test-'));
	t.teardown(() => rmSync(tmpDir, { recursive: true, force: true }));

	writeFileSync(join(tmpDir, 'package.json'), JSON.stringify({ name: 'test' }));
	writeFileSync(join(tmpDir, 'package-lock.json'), JSON.stringify({
		lockfileVersion: 3,
		packages: {
			'node_modules/some-package': {
				version: '1.0.0',
				// No resolved field - should be skipped
			},
		},
	}));
	writeFileSync(join(tmpDir, 'index.js'), 'const x = 1;');

	const eslint = createESLint({
		files: ['**/*.js'],
		plugins: { lockfile: plugin },
		rules: { 'lockfile/non-registry-specifiers': 'error' },
	}, tmpDir);

	const results = await eslint.lintFiles(['index.js']);
	t.equal(results[0].errorCount, 0, 'no errors for package without resolved URL');
	t.end();
});

test('non-registry-specifiers rule - virtual lockfile with non-HTTPS registry', async (t) => {
	const tmpDir = mkdtempSync(join(tmpdir(), 'eslint-plugin-lockfile-test-'));
	t.teardown(() => rmSync(tmpDir, { recursive: true, force: true }));

	// Create a package.json that will trigger virtual lockfile
	writeFileSync(join(tmpDir, 'package.json'), JSON.stringify({
		name: 'test',
		dependencies: {
			tape: '^5.0.0',
		},
	}));
	writeFileSync(join(tmpDir, 'index.js'), 'const x = 1;');

	const eslint = createESLint({
		files: ['**/*.js'],
		plugins: { lockfile: plugin },
		rules: { 'lockfile/non-registry-specifiers': 'error' },
	}, tmpDir);

	const results = await eslint.lintFiles(['index.js']);
	// Virtual lockfile will use HTTPS registries by default, so no errors expected
	// But this tests the virtual lockfile code path
	t.equal(results[0].errorCount, 0, 'virtual lockfile processed successfully');
	t.end();
});

test('non-registry-specifiers rule - yarn lockfile processes all packages', async (t) => {
	const tmpDir = mkdtempSync(join(tmpdir(), 'eslint-plugin-lockfile-test-'));
	t.teardown(() => rmSync(tmpDir, { recursive: true, force: true }));

	writeFileSync(join(tmpDir, 'package.json'), JSON.stringify({
		name: 'test',
		dependencies: {
			tape: '^5.0.0',
			eslint: '^8.0.0',
		},
	}));
	// Create a yarn.lock with multiple packages to ensure the last one is processed
	const yarnLock = `# THIS IS AN AUTOGENERATED FILE. DO NOT EDIT THIS FILE DIRECTLY.

tape@^5.0.0:
  version "5.7.5"
  resolved "https://registry.yarnpkg.com/tape/-/tape-5.7.5.tgz#abc123"
  integrity sha512-xxx

eslint@^8.0.0:
  version "8.57.0"
  resolved "https://registry.yarnpkg.com/eslint/-/eslint-8.57.0.tgz#def456"
  integrity sha512-yyy`;

	writeFileSync(join(tmpDir, 'yarn.lock'), yarnLock);
	writeFileSync(join(tmpDir, 'index.js'), 'const x = 1;');

	const eslint = createESLint({
		files: ['**/*.js'],
		plugins: { lockfile: plugin },
		rules: { 'lockfile/non-registry-specifiers': 'error' },
	}, tmpDir);

	const results = await eslint.lintFiles(['index.js']);
	t.equal(results[0].errorCount, 0, 'no errors with multiple packages in yarn.lock');
	t.end();
});

test('non-registry-specifiers rule - npm v1 lockfile with dependencies', async (t) => {
	const tmpDir = mkdtempSync(join(tmpdir(), 'eslint-plugin-lockfile-test-'));
	t.teardown(() => rmSync(tmpDir, { recursive: true, force: true }));

	writeFileSync(join(tmpDir, 'package.json'), JSON.stringify({
		name: 'test',
		dependencies: {
			tape: '^5.0.0',
		},
	}));
	writeFileSync(join(tmpDir, 'package-lock.json'), JSON.stringify({
		lockfileVersion: 1,
		dependencies: {
			tape: {
				version: '5.7.5',
				resolved: 'https://registry.npmjs.org/tape/-/tape-5.7.5.tgz',
				integrity: 'sha512-xxx',
			},
		},
	}));
	writeFileSync(join(tmpDir, 'index.js'), 'const x = 1;');

	const eslint = createESLint({
		files: ['**/*.js'],
		plugins: { lockfile: plugin },
		rules: { 'lockfile/non-registry-specifiers': 'error' },
	}, tmpDir);

	const results = await eslint.lintFiles(['index.js']);
	t.equal(results[0].errorCount, 0, 'no errors with npm v1 lockfile with dependencies');
	t.end();
});

test('non-registry-specifiers rule - npm v1 lockfile with git URL', async (t) => {
	const tmpDir = mkdtempSync(join(tmpdir(), 'eslint-plugin-lockfile-test-'));
	t.teardown(() => rmSync(tmpDir, { recursive: true, force: true }));

	writeFileSync(join(tmpDir, 'package.json'), JSON.stringify({
		name: 'test',
		dependencies: {
			'some-package': 'github:user/repo',
		},
	}));
	writeFileSync(join(tmpDir, 'package-lock.json'), JSON.stringify({
		lockfileVersion: 1,
		dependencies: {
			'some-package': {
				version: 'github:user/repo#abc123',
				resolved: 'git+https://github.com/user/repo.git#abc123',
			},
		},
	}));
	writeFileSync(join(tmpDir, 'index.js'), 'const x = 1;');

	const eslint = createESLint({
		files: ['**/*.js'],
		plugins: { lockfile: plugin },
		rules: { 'lockfile/non-registry-specifiers': 'error' },
	}, tmpDir);

	const results = await eslint.lintFiles(['index.js']);
	t.ok(results[0].errorCount > 0, 'error reported for git URL in npm v1 lockfile');
	t.ok(results[0].messages[0].message.includes('git+https://github.com'), 'error mentions git URL');
	t.end();
});

test('non-registry-specifiers rule - skips workspace packages with link: true', async (t) => {
	const tmpDir = mkdtempSync(join(tmpdir(), 'eslint-plugin-lockfile-test-'));
	t.teardown(() => rmSync(tmpDir, { recursive: true, force: true }));

	writeFileSync(join(tmpDir, 'package.json'), JSON.stringify({
		name: 'test-monorepo',
		workspaces: ['packages/*'],
	}));
	// npm lockfile with workspace packages (link: true)
	// The resolved path points to a local directory, not a URL
	writeFileSync(join(tmpDir, 'package-lock.json'), JSON.stringify({
		lockfileVersion: 3,
		packages: {
			'': {
				name: 'test-monorepo',
				workspaces: ['packages/*'],
			},
			'node_modules/@myorg/tasks': {
				resolved: 'packages/tasks',
				link: true,
			},
			'packages/tasks': {
				name: '@myorg/tasks',
				version: '0.0.1',
			},
		},
	}));
	writeFileSync(join(tmpDir, 'index.js'), 'const x = 1;');

	const eslint = createESLint({
		files: ['**/*.js'],
		plugins: { lockfile: plugin },
		rules: { 'lockfile/non-registry-specifiers': 'error' },
	}, tmpDir);

	const results = await eslint.lintFiles(['index.js']);
	// Workspace packages should be skipped - their local path resolved is not a non-registry specifier
	t.equal(results[0].errorCount, 0, 'no errors - workspace packages skipped');
	t.end();
});
